<?php
if (!defined("SPECIALCONSTANT"))
	die("Acceso denegado");

function generarApiKey($username){
	$apiKey = sha1($username + microtime().rand());
	return $apiKey;
}

function comprobarApiKey($apikey){
	try{
		$connection = getConnection();
		$dbquery = $connection->prepare("SELECT * FROM User WHERE User_apiKey = ?");
		$dbquery->bindParam(1,$apikey);
		$dbquery->execute();
		$number = $dbquery->rowCount();
		$connection = null;
		if($number > 0){
			return TRUE;
		}
		else{
			return FALSE;
		}
	} catch (PDOException $e) {
		return FALSE;
	}
}

$app->get("/", function() use($app) {
	$app->response->headers->set("Content-type", "text/html; charset=utf-8");
	$app->response->status(OK);
	$app->response->body(
	"<h1>RESTful API Classroom Reservation</h1><h2>Enrique Ramos</h2>
	<a href ='doc/index.html'>API Documentation</a>");
});

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// USER 	/////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/user.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ACTIVITY /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/activity.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ACTIVITY TROPHIES /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/activitytrophies.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ATTENDANT /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/attendant.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CHAT 	/////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/chat.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// COMMENT /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/comment.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CONFIGURATION /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/configuration.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// EVENT /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/event.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// FRIEND /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/friend.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// PHOTO /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/photo.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// POINT /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/point.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// STATISTICS /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/statistics.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// TROPHIE /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/trophie.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// USER TROPHIES /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
include_once("models/usertrophies.php");

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// EMAIL /////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//

$app->post("/api/email(/:apikey)", function($apikey=null) use($app) {
	//get params
	$json = $app->request->post('email');
	$email = json_decode($json);

	$result = new Result();
	$result->setCode(FALSE);
	$result->setStatus(CONFLICT);
	$result->setMessage("Invalid Api Key!!");
	
	if(comprobarApiKey($apikey))
		$result = sendEmail($email->from, $email->passwd, $email->to, $email->subject, $email->message); // Enviar mail
	$app->response->status($result->getCode());
	$app->response->body(json_encode($result));
});

function sendEmail($from, $password, $to, $subject, $message){
	header('Content-type: application/json;charset=utf8');
	require_once('phpmailer524/class.phpmailer.php');
	//include("class.smtp.php"); // optional, gets called from within class.phpmailer.php if not already loaded
	require_once "config.php";
	$response = new Result();

	$mail = new PHPMailer(true);
	// the true param means it will throw exceptions on errors, which we need to catch
	$mail->IsSMTP(); // telling the class to use SMTP
	try {
		$mail->SMTPDebug = 2;
		// enables SMTP debug information (for testing)
		//$mail->SMTPDebug = 0;
		$mail->SMTPAuth = true;
		// enable SMTP authentication
		$mail->SMTPSecure = "tls";
		// sets the prefix to the server
		$mail->Host = "outlook.websitewelcome.com";
		// sets GMAIL as the SMTP server
		//$mail->Host = "smtp.openmailbox.org";
		$mail->Port = 587;
		// set the SMTP port for the GMAIL server
		$mail->Username = $from;
		// GMAIL username
		$mail->Password = $password;
		// GMAIL password
		$mail->AddAddress($to);
		// Receiver email
		$mail->SetFrom($from, 'Admin.');
		// email sender
		$mail->AddReplyTo($from, 'Admin.');
		// email to reply
		$mail->Subject = $subject;
		// subject of the message
		$mail->AltBody = 'Admin - Incidencias';
		// optional - MsgHTML will create an alternate automatically
		$mail->MsgHTML($message);
		//
		$mail->Send();
		$response->setCode(TRUE);
		$response->setMessage("Message Sent OK to " . $to);
		echo json_encode($response);
	}	 catch (phpmailerException $e) {
		$response->setCode(FALSE);
		$response->setMessage("Error: " . $e->errorMessage());
		echo json_encode($response);
	} catch (Exception $e) {
		$response->setCode(FALSE);
		$response->setMessage("Error: " . $e->getMessage());
		echo json_encode($response);
	}

	return $response;
}

?>